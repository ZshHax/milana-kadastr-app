import streamlit as st
import pandas as pd
import plotly.express as px
import numpy as np
import os

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(page_title="–ê–ò–°: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ó–µ–º–µ–ª—å", page_icon="üåç", layout="wide", initial_sidebar_state="expanded")

# ==========================================
# –ö–ê–°–¢–û–ú–ù–´–ô CSS (–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞, —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã)
# ==========================================
st.markdown("""
    <style>
    /* –ü—Ä—è—á–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –º–µ–Ω—é Streamlit */
    #MainMenu {visibility: hidden;}
    footer {visibility: hidden;}
    
    /* –î–µ–ª–∞–µ–º —Ñ–æ–Ω —Å—Ç—Ä–æ–≥–æ —Å–≤–µ—Ç–ª—ã–º */
    [data-testid="stAppViewContainer"] {
        background-color: #FFFFFF;
        color: #111111;
    }
    
    /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
    [data-testid="stSidebar"] {
        background-color: #F8F9FA;
        border-right: 1px solid #EAEAEA;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –ª–æ–≥–æ—Ç–∏–ø–∞ –ê—É—ç–∑–æ–≤–∞ */
    .auezov-text {
        text-align: center; 
        color: #1A1A1A; /* –¢–µ–º–Ω—ã–π —Å—Ç—Ä–æ–≥–∏–π —Ç–µ–∫—Å—Ç */
        font-weight: 900; 
        font-size: 22px;
        font-family: 'Arial', sans-serif;
        letter-spacing: 1.5px;
        line-height: 1.2;
        margin-top: 5px;
        margin-bottom: 25px;
    }
    .auezov-year {
        font-size: 16px;
        color: #444444;
        font-weight: bold;
    }
    
    /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ KPI (–ú–µ—Ç—Ä–∏–∫) */
    div[data-testid="metric-container"] {
        background-color: #FFFFFF;
        border: 1px solid #E0E0E0;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0px 4px 6px rgba(0,0,0,0.02);
        border-left: 5px solid #4B0082; /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π –∞–∫—Ü–µ–Ω—Ç –ê—É—ç–∑–æ–≤–∞ */
    }
    </style>
    """, unsafe_allow_html=True)

# ==========================================
# –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ (–° –ª–æ–≥–æ—Ç–∏–ø–æ–º –∏ —Ç–µ–∫—Å—Ç–æ–º)
# ==========================================
with st.sidebar:
    # –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –æ—Ä–ª–∞
    col1, col2, col3 = st.columns([1, 4, 1])
    with col2:
        if os.path.exists("logo.png"):
            st.image("logo.png", use_container_width=True)
        elif os.path.exists("logo.jpg"):
            st.image("logo.jpg", use_container_width=True)
        
    # –¢–µ–∫—Å—Ç –ª–æ–≥–æ—Ç–∏–ø–∞
    st.markdown('''
        <div class="auezov-text">
            AUEZOV<br>
            UNIVERSITY<br>
            <span class="auezov-year">1943</span>
        </div>
    ''', unsafe_allow_html=True)
        
    st.markdown("---")
    st.markdown("### üéì –ü–∞—Å–ø–æ—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞")
    st.markdown("**–í—ã–ø–æ–ª–Ω–∏–ª–∞:** –ö–æ—à–∞–Ω–æ–≤–∞ –ú.–ó.")
    st.markdown("**–§–∞–∫—É–ª—å—Ç–µ—Ç:** –ê–≥—Ä–∞—Ä–Ω—ã–π")
    st.markdown("**–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:** –ö–∞–¥–∞—Å—Ç—Ä")
    st.markdown("**–ì—Ä—É–ø–ø–∞:** –ê–ø 24-6—Ä")
    st.markdown("---")
    st.markdown("**–ë–∞–∑–∞:** –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–µ–º–µ–ª—å–Ω—ã–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏")
    st.markdown("**–¢–µ–º–∞:** –†–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–µ–º–µ–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤")

# ==========================================
# –û–°–ù–û–í–ù–ê–Ø –ß–ê–°–¢–¨
# ==========================================
st.markdown("<h1 style='color: #1A1A1A;'>üåç –ì–ò–°-–ø–∞–Ω–µ–ª—å: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–µ–º–µ–ª—å–Ω–æ–≥–æ —Ñ–æ–Ω–¥–∞</h1>", unsafe_allow_html=True)
st.markdown("*–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ-–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –¥–∞—à–±–æ—Ä–¥ –¥–ª—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∑–µ–º–µ–ª—å.*")

# KPI –ú–µ—Ç—Ä–∏–∫–∏
col1, col2, col3, col4 = st.columns(4)
col1.metric("–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å (—Ç—ã—Å. –≥–∞)", "1 250", "+12.5% –∫ –ø—Ä–æ—à–ª–æ–º—É –≥–æ–¥—É")
col2.metric("–í —Å–µ–ª—å—Ö–æ–∑–æ–±–æ—Ä–æ—Ç–µ (—Ç—ã—Å. –≥–∞)", "840", "-2.1% –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è")
col3.metric("–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞—Ä—É—à–µ–Ω–∏–π", "142", "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å")
col4.metric("–û—Ü–µ–Ω–∫–∞ —É—â–µ—Ä–±–∞ (–º–ª–Ω ‚Ç∏)", "28.5", "–ù–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –ö–æ–ê–ü")

st.markdown("<br>", unsafe_allow_html=True)

# –í–∫–ª–∞–¥–∫–∏
tab1, tab2, tab3, tab4 = st.tabs(["üó∫Ô∏è –ö–∞—Ä—Ç–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–π (–ì–ò–°)", "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "üóÑÔ∏è –†–µ–µ—Å—Ç—Ä", "üí∞ –ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∞–Ω–∫—Ü–∏–π"])

with tab1:
    st.subheader("–ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏–π (–≥. –®—ã–º–∫–µ–Ω—Ç)")
    
    np.random.seed(42)
    lats = np.random.randn(60) / 40 + 42.3154
    lons = np.random.randn(60) / 40 + 69.5858
    areas = np.random.randint(1, 150, 60)
    damages = np.random.randint(100, 5000, 60)
    districts = np.random.choice(['–ï–Ω–±–µ–∫—à–∏–Ω—Å–∫–∏–π', '–ê–±–∞–π—Å–∫–∏–π', '–ê–ª—å-–§–∞—Ä–∞–±–∏–π—Å–∫–∏–π', '–ö–∞—Ä–∞—Ç–∞—É—Å–∫–∏–π'], 60)
    
    map_data = pd.DataFrame({'lat': lats, 'lon': lons, '–ü–ª–æ—â–∞–¥—å (–≥–∞)': areas, '–£—â–µ—Ä–± (—Ç—ã—Å. ‚Ç∏)': damages, '–†–∞–π–æ–Ω': districts})
    
    fig_map = px.scatter_mapbox(
        map_data, lat="lat", lon="lon", color="–£—â–µ—Ä–± (—Ç—ã—Å. ‚Ç∏)", size="–ü–ª–æ—â–∞–¥—å (–≥–∞)",
        color_continuous_scale=px.colors.sequential.Purples, size_max=20, zoom=10.5,
        mapbox_style="carto-positron", hover_name="–†–∞–π–æ–Ω",
        center={"lat": 42.3154, "lon": 69.5858}
    )
    fig_map.update_layout(margin={"r":0,"t":0,"l":0,"b":0})
    st.plotly_chart(fig_map, use_container_width=True)

with tab2:
    col1, col2 = st.columns(2)
    with col1:
        st.subheader("–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–µ–º–µ–ª—å–Ω–æ–≥–æ —Ñ–æ–Ω–¥–∞")
        df_pie = pd.DataFrame({
            '–ö–∞—Ç–µ–≥–æ—Ä–∏—è': ['–ü–∞—à–Ω–∏ (–†–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)', '–ü–∞—Å—Ç–±–∏—â–∞', '–ó–µ–º–ª–∏ –∑–∞–ø–∞—Å–∞', '–ó–µ–º–ª–∏ –Ω–∞—Å. –ø—É–Ω–∫—Ç–æ–≤', '–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å', '–î–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ'],
            '–ü–ª–æ—â–∞–¥—å': [350, 250, 150, 120, 80, 50]
        })
        fig_pie = px.pie(df_pie, values='–ü–ª–æ—â–∞–¥—å', names='–ö–∞—Ç–µ–≥–æ—Ä–∏—è', hole=0.5, 
                         color_discrete_sequence=px.colors.sequential.Purples_r)
        fig_pie.update_traces(textposition='inside', textinfo='percent+label')
        st.plotly_chart(fig_pie, use_container_width=True)
        
    with col2:
        st.subheader("–î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–∞–≤–æ–Ω–∞—Ä—É—à–µ–Ω–∏–π")
        df_bar = pd.DataFrame({
            '–ì–æ–¥': ['2023', '2024', '2025', '2026 (–ø—Ä–æ–≥–Ω–æ–∑)'],
            '–ù–µ—Ü–µ–ª–µ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ': [45, 60, 52, 30],
            '–°–∞–º–æ–≤–æ–ª—å–Ω—ã–π –∑–∞—Ö–≤–∞—Ç': [20, 25, 30, 15],
            '–ü–æ—Ä—á–∞ –∑–µ–º–µ–ª—å': [10, 12, 8, 5]
        })
        fig_bar = px.bar(df_bar, x='–ì–æ–¥', y=['–ù–µ—Ü–µ–ª–µ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ', '–°–∞–º–æ–≤–æ–ª—å–Ω—ã–π –∑–∞—Ö–≤–∞—Ç', '–ü–æ—Ä—á–∞ –∑–µ–º–µ–ª—å'], 
                         barmode='group', color_discrete_sequence=['#4B0082', '#9370DB', '#DDA0DD'])
        st.plotly_chart(fig_bar, use_container_width=True)

with tab3:
    st.subheader("–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä –∑–µ–º–µ–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤")
    df_db = pd.DataFrame({
        '–ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä': ['19-322-045-121', '19-322-045-877', '19-322-011-002', '19-322-099-443', '19-322-012-105'],
        '–õ–æ–∫–∞—Ü–∏—è': ['–ï–Ω–±–µ–∫—à–∏–Ω—Å–∫–∏–π —Ä-–Ω', '–ê–±–∞–π—Å–∫–∏–π —Ä-–Ω', '–°–∞–π—Ä–∞–º—Å–∫–∏–π —Ä-–Ω', '–ê–ª—å-–§–∞—Ä–∞–±–∏–π—Å–∫–∏–π —Ä-–Ω', '–¢–æ–ª–µ–±–∏–π—Å–∫–∏–π —Ä-–Ω'],
        '–ü–ª–æ—â–∞–¥—å (–≥–∞)': [12.5, 0.8, 45.0, 0.15, 120.0],
        '–í—ã—è–≤–ª–µ–Ω–Ω–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ': ['–î–µ–≥—Ä–∞–¥–∞—Ü–∏—è –ø–∞—Å—Ç–±–∏—â', '–ù–µ–∑–∞–∫–æ–Ω–Ω–∞—è –ø–æ—Å—Ç—Ä–æ–π–∫–∞', '–ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è > 2 –ª–µ—Ç', '–ó–∞—Ö–ª–∞–º–ª–µ–Ω–∏–µ –æ—Ç—Ö–æ–¥–∞–º–∏', '–°–Ω—è—Ç–∏–µ —Å–ª–æ—è'],
        '–°—Ç–∞—Ç—É—Å –¥–µ–ª–∞': ['–í—ã–¥–∞–Ω–æ –ø—Ä–µ–¥–ø–∏—Å–∞–Ω–∏–µ', '–ü–µ—Ä–µ–¥–∞–Ω–æ –≤ —Å—É–¥', '–ò–∑—ä—è—Ç–æ', '–û–∂–∏–¥–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏', '–®—Ç—Ä–∞—Ñ –≤–∑—ã—Å–∫–∞–Ω']
    })
    st.dataframe(df_db, use_container_width=True, hide_index=True)

with tab4:
    st.subheader("–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∑—ã—Å–∫–∞–Ω–∏–π")
    
    col1, col2 = st.columns([1, 1.5])
    with col1:
        area = st.number_input("–ü–ª–æ—â–∞–¥—å —É—á–∞—Å—Ç–∫–∞ (–≥–∞):", min_value=0.1, value=10.0, step=1.0)
        violation_type = st.selectbox("–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–∞—Ä—É—à–µ–Ω–∏—è:", ["–ù–µ—Ü–µ–ª–µ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ", "–£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –ø–ª–æ–¥–æ—Ä–æ–¥–Ω–æ–≥–æ —Å–ª–æ—è", "–°–∞–º–æ–≤–æ–ª—å–Ω—ã–π –∑–∞—Ö–≤–∞—Ç"])
        subject = st.radio("–°—É–±—ä–µ–∫—Ç –ø—Ä–∞–≤–∞:", ["–§–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ", "–ú–∞–ª–æ–µ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å—Å—Ç–≤–æ", "–ö—Ä—É–ø–Ω–æ–µ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å—Å—Ç–≤–æ"])

    with col2:
        mrp = 3932 
        
        base_mult = 10
        if subject == "–ú–∞–ª–æ–µ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å—Å—Ç–≤–æ": base_mult = 40
        elif subject == "–ö—Ä—É–ø–Ω–æ–µ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å—Å—Ç–≤–æ": base_mult = 150
        
        if violation_type == "–£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –ø–ª–æ–¥–æ—Ä–æ–¥–Ω–æ–≥–æ —Å–ª–æ—è": base_mult *= 1.8
        elif violation_type == "–°–∞–º–æ–≤–æ–ª—å–Ω—ã–π –∑–∞—Ö–≤–∞—Ç": base_mult *= 2.5
        
        total_fine = int((mrp * base_mult) * (1 + (area * 0.05)))
        
        st.metric(label="–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞ –≤–∑—ã—Å–∫–∞–Ω–∏—è (–¢–µ–Ω–≥–µ):", value=f"{total_fine:,}".replace(',', ' '))
        st.info("üí° –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å—á–µ—Ç–∞ —É—á–∏—Ç—ã–≤–∞–µ—Ç –±–∞–∑–æ–≤—É—é —Å—Ç–∞–≤–∫—É –ú–†–ü, —Å—É–±—ä–µ–∫—Ç –±–∏–∑–Ω–µ—Å–∞ –∏ –º–∞—Å—à—Ç–∞–± (–ø–ª–æ—â–∞–¥—å) –Ω–∞—Ä—É—à–µ–Ω–∏—è.")
